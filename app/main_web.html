<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>é…å°èŠå¤©å®¤</title>
        <style>
        /*é–‹å§‹è¨­å®š<body> å°±æ˜¯ä½ ã€Œç•«é¢ä¸Šçœ‹åˆ°çš„æ‰€æœ‰æ±è¥¿ã€çš„åœ°æ–¹*/
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f2f4f8;
            margin: 0; /*ç§»é™¤ç€è¦½å™¨é è¨­çš„å¤–è·ã€‚*/
            padding: 0;/*åŒä¸Šï¼Œé€™æ¬¡æ˜¯æ¸…é™¤ã€Œå…§è·ã€ã€‚ é€™æ˜¯ç‚ºäº†è®“ç•«é¢å¾æœ€é‚Šé‚Šé–‹å§‹ã€‚*/
            display: flex; /*ä½¿ç”¨ã€Œå½ˆæ€§ç›’å­æ’ç‰ˆã€(flexbox)  é€™æ¨£å¯ä»¥è®“å­å…ƒç´ å¾ˆæ–¹ä¾¿åœ°æ’åˆ—ã€å°é½Šã€‚*/
            flex-direction: column;/*æŒ‡å®šå…§å®¹è¦ã€Œå‚ç›´æ’åˆ—ã€ï¼ˆä¸Šä¸‹æ–¹å‘ï¼‰ã€‚*/
            align-items: center;/*æŠŠå…§å®¹ã€Œæ°´å¹³ç½®ä¸­ã€*/

        }
        /*é€™ä¸€æ®µæ˜¯é‡å° <h1> æ¨™ç±¤ï¼ˆä¸»æ¨™é¡Œï¼‰è¨­å®šçš„æ¨£å¼ã€‚*/
        h1{
            margin-top: 20px; /*ä¸è¦ç·Šè²¼ç€è¦½å™¨æœ€ä¸Šç·£*/
            color: #333; /*æ–‡å­—é¡è‰²ç‚ºæ·±ç°è‰²*/

        }
        /* åŒ…å«æ•´å€‹èŠå¤©å®¤å€åŸŸçš„å¡ç‰‡ */
        .chat-container{
            background-color: white; /* èƒŒæ™¯ç™½è‰² */
            border-radius: 12px; /*å››å€‹é‚Šè§’éƒ½è®Šæˆåœ“è§’ */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* é™°å½±æ•ˆæœ */
            width: 90vw;/* å¯¬åº¦ç‚ºè¦–çª—å¯¬åº¦ 90% */
            max-width: 600px; /* æœ€å¤§å¯¬åº¦é™åˆ¶ç‚º 600px */
            padding: 20px; /* å…§å®¹èˆ‡é‚Šç•Œä¹‹é–“æœ‰ 20px çš„ã€Œå…§è·ã€ */
            margin-top: 20px; /*è®“æ•´å€‹èŠå¤©å®¤å€å¡Šå¾€ä¸‹ç§»å‹• 20pxï¼Œä¸æœƒç·Šè²¼è‘—ä¸Šé¢çš„æ¨™é¡Œ <h1>ã€‚*/
            display: flex;/*é€™å€‹ .chat-container è¨­æˆ Flex æ’ç‰ˆå®¹å™¨ã€‚é€™æ¨£å®ƒè£¡é¢çš„å…ƒç´ ï¼ˆåƒæ˜¯è¼¸å…¥å€ã€è¨Šæ¯å€ï¼‰å¯ä»¥ç”¨å½ˆæ€§æ–¹å¼æ’åˆ—ã€‚*/
            flex-direction: column; /* Flex çš„æ’åˆ—æ–¹å‘æ˜¯ã€Œå‚ç›´çš„*/
            overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸æœƒè¶…å‡ºå®¹å™¨ */
        }
        /* ä¸Šä¸‹æ–¹è¼¸å…¥å€ï¼ˆinput + buttonï¼‰çš„æ©«å‘æ’åˆ— */
        .input-group{
            display: flex; /* æ©«å‘æ’åˆ— */
            gap: 10px; /* å…ƒç´ é–“è· 10px */
            margin-bottom: 10px; /*è®“é€™å€‹æ•´å¡Š .input-group å’Œä¸‹æ–¹çš„å€å¡Šä¹‹é–“ç•™ 10px çš„å‚ç›´è·é›¢ã€‚*/
            flex-wrap: wrap; /* å…ƒç´ å¤ªæ“ æœƒè‡ªå‹•æ›è¡Œ */
            margin-bottom: 12px; /* æ¯ä¸€å€ä¹‹é–“ç©º 12pxï¼Œçœ‹èµ·ä¾†æ¯”è¼ƒæ¸…æ¥š */
        }
        /*è¼¸å…¥æ¨™é¡Œ*/
        .input-group label {
            white-space: nowrap; /* é˜²æ­¢æ›è¡Œ */
        }
        /* æ‰€æœ‰æ–‡å­—è¼¸å…¥æ¡†çš„æ¨£å¼ */
        input[type=text]{
            height: 42px; /* çµ±ä¸€é«˜åº¦ */
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒè¶…å‡ºé€™å€‹é«˜åº¦ */
            flex: 1; /* è®“ input æ’æ»¿å¯ç”¨ç©ºé–“ */
            padding: 10px; /*çµ¦é€™å€‹è¼¸å…¥æ¡†çš„å…§è·ï¼ˆæ–‡å­—å’Œé‚Šæ¡†ä¹‹é–“çš„ç©ºé–“ï¼‰*/
            font-size: 16px; /*è¨­å®šè¼¸å…¥æ–‡å­—çš„å¤§å°ç‚º 16px*/
            border-radius: 6px; /* åœ“è§’ */
            border: 1px solid #ccc; /*åŠ ä¸Šä¸€å€‹ 1px çš„é‚Šæ¡†ï¼Œé¡è‰²æ˜¯ #cccï¼ˆç°è‰²ï¼‰*/

        }
        /* æ‰€æœ‰æŒ‰éˆ•çš„æ¨£å¼ */
        button{
            padding: 10px 15px; /*ä¸Šä¸‹ç•™ 10px ç©ºé–“ï¼ˆè®“æŒ‰éˆ•æœ‰ã€Œé«˜åº¦ã€ï¼‰å·¦å³ç•™ 15px ç©ºé–“ï¼ˆè®“å­—ä¸æœƒè²¼é‚Šï¼‰*/
            font-size: 16px; /*æŒ‰éˆ•ä¸Šçš„æ–‡å­—å¤§å°è¨­ç‚º 16px*/
            background-color: #007bff; /* è—è‰²èƒŒæ™¯ */
            color: white; /*æŒ‰éˆ•æ–‡å­—ç‚ºç™½è‰²*/
            border: none;/* ç„¡é‚Šæ¡† */
            border-radius: 6px; /* åœ“è§’ */
            cursor: pointer; /* æ»‘é¼ è®Šæ‰‹æŒ‡ */
        }
        #chat-box{
            height: 50vh; /*é«˜åº¦ä½”æ•´å€‹ç€è¦½å™¨è¦–çª—çš„ä¸€åŠ*/
            overflow-y: auto ; /* å¦‚æœå…§å®¹è¶…å‡ºå€åŸŸé«˜åº¦ï¼Œå‡ºç¾ã€Œå‚ç›´æ»¾å‹•æ¢ã€ã€‚*/
            padding: 10px; /*å…§å®¹å…§è·ï¼Œè®“è¨Šæ¯ä¸æœƒè²¼é‚Šï¼Œæ–‡å­—é¡¯ç¤ºæ›´èˆ’æœã€‚*/
            border: 1px solid #ccc;/*åŠ ä¸Šä¸€åœˆç°è‰²ç´°é‚Šæ¡†ï¼Œè®“å€å¡Šçœ‹èµ·ä¾†æ›´æœ‰è¼ªå»“æ„Ÿã€‚*/
            border-radius: 6px;/*åœ“è§’*/
            background-color: #fafafa; /* æ·ºç°èƒŒæ™¯ */
            margin-bottom: 10px; /*é€™å€‹èŠå¤©å€èˆ‡ä¸‹é¢è¼¸å…¥æ¡†å€ä¹‹é–“ç•™ 10px çš„ç©ºéš™ã€‚*/
            display: flex; /*æŠŠé€™å€‹èŠå¤©å€è®Šæˆã€Œå½ˆæ€§ç›’å­ï¼ˆflexboxï¼‰ã€å®¹å™¨ã€‚*/
            flex-direction: column; /*æ’åˆ—æ–¹å‘æ”¹ç‚ºå‚ç›´ï¼Œä¹Ÿå°±æ˜¯è¨Šæ¯æœƒä¸€æ¢æ¥ä¸€æ¢å¾€ä¸‹æ’ã€‚*/
            gap: 6px; /*æ¯æ¢è¨Šæ¯æ³¡æ³¡ä¹‹é–“ï¼Œè‡ªå‹•ç•™ 6px çš„ç©ºéš™ã€‚*/


        }
                /* å–®ä¸€è¨Šæ¯æ³¡æ³¡æ¨£å¼ */
        .message {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-break: break-word; /* é¿å…å­—å¤ªé•·ä¸æ›è¡Œ */
        }

        .me {
            align-self: flex-end; /* å³å´é¡¯ç¤º */
            background-color: #cce5ff; /* æ·ºè—èƒŒæ™¯ */
        }

        .other {
            align-self: flex-start; /* å·¦å´é¡¯ç¤º */
            background-color: #e2e3e5; /* ç°è‰²èƒŒæ™¯ */
        }

        .system {
            align-self: center; /* å±…ä¸­é¡¯ç¤º */
            font-style: italic;
            color: #777; /* ç°å­— */
        }

    </style>
</head>
<body>
    <h1>é›™äººèŠå¤©å®¤</h1>
    <div class="chat-container"> <!--èŠå¤©å®¤ä¸»é«”å®¹å™¨-->

        <!-- ä½¿ç”¨è€…è¼¸å…¥éŠæˆ²åèˆ‡æš±ç¨± -->
        <div class="input-group">
        <label for="game_input" style="align-self: center;">éŠæˆ²åç¨±ï¼š</label>
        <input type="text" id="game_input" value="apex" /><!--å¯ä»¥è‡ªè¡Œè¼¸å…¥éŠæˆ² é è¨­ç‚ºapex -->
        </div>

        <div class="input-group">
        <label for="nickname_input" style="align-self: center;">ä½ çš„æš±ç¨±ï¼š</label>
        <input type="text" id="nickname_input" placeholder="è¼¸å…¥æš±ç¨±"  value="åŒ¿å" />
        <button id="connect_button" onclick="connect()">åŠ å…¥</button>
        </div>

        <!-- è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
        <div id="chat-box"></div>
        <!-- ä½¿ç”¨è€…è¼¸å…¥è¨Šæ¯èˆ‡é€å‡º -->
        <div class="input-group">
                <input type="text" id="message_input" placeholder="è¼¸å…¥è¨Šæ¯"/>
    
                <button id="send_button" onclick="sendMessage()">é€å‡º</button>
        </div>
        </div>
    
<script>
    let ws;

    const client_id = Math.random().toString(36).substring(2);// éš¨æ©Ÿç”¢ç”Ÿç”¨æˆ¶ ID

    function connect(){
        const game = document.getElementById("game_input").value;
        const host = window.location.host;
        const nickname = encodeURIComponent(document.getElementById("nickname_input").value.trim());
        const time = getCurrentTime();//å–å¾—ç¾åœ¨æ™‚é–“
        //æª¢æŸ¥ ws æ˜¯å¦å·²ç¶“å­˜åœ¨ä¸”ç‚ºé–‹å•Ÿç‹€æ…‹
        if (ws && ws.readyState === WebSocket.OPEN) {
            addSystemMessage(time, "âš ï¸ ä½ å·²ç¶“é€£ç·šäº†ï¼Œä¸ç”¨å†åŠ å…¥ï¼");
            return;
        }
        else{
            // å»ºç«‹ WebSocket é€£ç·š
            //ws = new WebSocket(`wss://${host}/ws/${game}?id=${client_id}&nickname=${nickname}`); //"wss://<host>/ws/<game>" å°æ‡‰åˆ°fastapiçš„"/ws/{game}"
            ws = new WebSocket(`ws://${host}/ws/${game}?id=${client_id}&nickname=${nickname}`); 
            addSystemMessage(time,"ğŸ”— å·²åŠ å…¥é…å°ä¸­"); 

        }


        // è¨­å®šæ¥æ”¶è¨Šæ¯äº‹ä»¶
        ws.onmessage = function(event){
            const time = getCurrentTime();//å–å¾—ç¾åœ¨æ™‚é–“
            const isMine = event.data.startsWith("ä½ èªª") || event.data.includes("âš ï¸") || event.data.includes("ç³»çµ±åˆ¤å®šæ­¤è¨Šæ¯å«æœ‰ä¸ç•¶å…§å®¹ï¼Œæœªå‚³é€");
            const isSystem = event.data.includes("é…å°") || event.data.includes("æ–·é–‹");
            const who = isSystem ? "system" :  isMine ? "me"  :  "other"; //ä¸‰åŸé‹ç®—å­ if isSystem ->"system" if isMine ->"me" else ->"other"
            addChatMessage(event.data, who, time);
            // ğŸŸ¡ é—œéµæ–°å¢ï¼šå¦‚æœå°æ–¹é›¢é–‹èŠå¤©å®¤ï¼Œå¼·åˆ¶é—œé–‰è‡ªå·±çš„é€£ç·š
            if (event.data.includes("é›¢é–‹èŠå¤©å®¤")) {
                ws.close(); // é—œé–‰ WebSocket
                
    }
            
        };
        
        //æ–·ç·šè™•ç†
        ws.onclose = function(event){
            const time = getCurrentTime(); //å–å¾—ç¾åœ¨æ™‚é–“
            addSystemMessage(time,"âŒ èŠå¤©å®¤å·²æ–·é–‹ï¼š" + event.reason); //åŠ å…¥æ™‚é–“+ç³»çµ±è¨Šæ¯
            document.getElementById("connect_button").disabled = false; // ä¿éšªé–‹å•ŸæŒ‰éˆ•
        };
    }
    // å‚³é€è¨Šæ¯çµ¦å¾Œç«¯  
    function sendMessage() {
        const input = document.getElementById("message_input");
        const text = input.value.trim();
        const time = getCurrentTime();//å–å¾—ç¾åœ¨æ™‚é–“
        //å¦‚æœwbsocketç‚ºé€£ç·šç‹€æ…‹çš„è©±
        if(ws && ws.readyState ===  WebSocket.OPEN){
            //åŠ å…¥å‚³å‡ºç©ºç™½è¨Šæ¯é˜²å‘†
            if (text !== "") {
                ws.send(text);
                input.value = '';
            }
        }
        else{
            addSystemMessage(time,"âš ï¸ å°šæœªé€£ç·šèŠå¤©å®¤");
        }
    }
    //æŠŠä¸€å‰‡è¨Šæ¯é¡¯ç¤ºæˆæ³¡æ³¡åŠ å…¥åˆ°èŠå¤©å€è£¡é¢ã€‚
    function addChatMessage(text, class_name,time){
        const box = document.getElementById("chat-box");
        const msg = document.createElement("div") ;//ä¸€å‰‡èŠå¤©è¨Šæ¯çš„å®¹å™¨
        msg.className = `message ${class_name}`; //å¹«å‰›å‰›å‰µå¥½çš„ msg åŠ ä¸Š class æ¨£å¼
        msg.innerText = `${time} ${text}`; //æ™‚é–“ + è¨Šæ¯æ–‡å­—
        box.appendChild(msg); //æŠŠå‰›å‰›å‰µå¥½çš„ msg divï¼ˆè¨Šæ¯æ³¡æ³¡ï¼‰åŠ åˆ°èŠå¤©æ¡† chat-box è£¡é¢å»
        box.scrollTop = box.scrollHeight; //é€™æ˜¯è®“ç•«é¢ã€Œè‡ªå‹•æ²åˆ°æœ€ä¸‹é¢ã€ï¼Œç¢ºä¿ä½ å¯ä»¥çœ‹åˆ°æœ€æ–°è¨Šæ¯ï¼


    }
    //åŠ å…¥ç³»çµ±è¨Šæ¯
    function addSystemMessage(time,text){
        const box = document.getElementById("chat-box"); // ç”¨ JavaScript æŠ“å–ç•«é¢ä¸Š ID ç‚º chat-box çš„é‚£å€‹å€å¡Š
        const msg = document.createElement("div"); //ç”¨ JavaScript å»ºç«‹ä¸€å€‹æ–°çš„ <div> å…ƒç´ ï¼Œç”¨ä¾†åŒ…ä½é€™æ¬¡çš„ç³»çµ±è¨Šæ¯
        msg.className = "message system"; // æŠŠå‰›å‰›å»ºç«‹çš„ msg åŠ ä¸Šä¸€å€‹ class åç¨±å« "system" é€™æœƒè®“é€™å€‹å…ƒç´ å¥—ç”¨ CSS ä¸­ .system çš„æ¨£å¼
        msg.innerText = `${time} ${text}`; // æŠŠä½ å‚³é€²ä¾†çš„æ–‡å­—å¡é€²é€™å€‹ msg å…ƒç´ è£¡ã€‚
        box.appendChild(msg);
        box.scrollTop = box.scrollHeight; //é€™æ˜¯è®“ç•«é¢ã€Œè‡ªå‹•æ²åˆ°æœ€ä¸‹é¢ã€ï¼Œç¢ºä¿ä½ å¯ä»¥çœ‹åˆ°æœ€æ–°è¨Šæ¯ï¼
    }

    //å–å¾—ç¾åœ¨æ™‚é–“
    function getCurrentTime(){
        const now = new Date();
        return now.toLocaleString('zh-TW',{hour12:false});

    }

    // Enter äº‹ä»¶ç›£è½å™¨
    document.getElementById("message_input").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            sendMessage();
        }
    });





        
    </script>
</body>
</html>